{
  "Name": "Enrich URL",
  "Description": "Enrich URL using information from Pulsedive.",
  "Script": "from ScriptResult import EXECUTION_STATE_COMPLETED, EXECUTION_STATE_FAILED, EXECUTION_STATE_INPROGRESS\nfrom SiemplifyAction import SiemplifyAction\nfrom SiemplifyDataModel import EntityTypes\nfrom SiemplifyUtils import output_handler, convert_dict_to_json_result_dict\nfrom TIPCommon import extract_configuration_param, extract_action_param, construct_csv, add_prefix_to_dict\nfrom PulsediveManager import PulsediveManager\nfrom constants import PROVIDER_NAME, INTEGRATION_NAME, ENRICH_URL_SCRIPT_NAME, DEFAULT_COMMENTS_COUNT, \\\n    DATA_ENRICHMENT_PREFIX, RISK_SCORE, RISK_NAME, COMPLETED, IN_PROGRESS\nfrom exceptions import PulsediveNotFoundException, ForceRaiseException\nimport sys\nimport json\nfrom UtilsManager import get_entity_original_identifier, prepare_entity_for_manager\n\n\n@output_handler\ndef main():\n    siemplify = SiemplifyAction()\n    siemplify.script_name = ENRICH_URL_SCRIPT_NAME\n\n    siemplify.LOGGER.info(\"----------------- Main - Param Init -----------------\")\n\n    api_root = extract_configuration_param(siemplify, provider_name=INTEGRATION_NAME, param_name=\"API Root\")\n    api_key = extract_configuration_param(siemplify, provider_name=INTEGRATION_NAME, param_name=\"API Key\")\n    verify_ssl = extract_configuration_param(siemplify, provider_name=INTEGRATION_NAME, param_name=\"Verify SSL\",\n                                             default_value=True, input_type=bool)\n                                             \n    retrieve_comments = extract_action_param(siemplify, param_name=\"Retrieve Comments\", is_mandatory=False,\n                                                 input_type=bool)\n    max_returned_comments = extract_action_param(siemplify, param_name=\"Max Comments To Return\", is_mandatory=False,\n                                                 input_type=int, default_value=DEFAULT_COMMENTS_COUNT)\n    only_suspicious_insight = extract_action_param(siemplify, param_name=\"Only Suspicious Entity Insight\",\n                                                   is_mandatory=False, input_type=bool, default_value=False)\n    threshold = extract_action_param(siemplify, param_name=\"Threshold\", is_mandatory=True, print_value=True)\n\n    siemplify.LOGGER.info(\"----------------- Main - Started -----------------\")\n\n    successful_entities = []\n    failed_entities = []\n    global_is_risky = False\n\n    status = EXECUTION_STATE_COMPLETED\n    json_results = {}\n    result_value = \"false\"\n    output_message = \"\"\n\n    suitable_entities = [entity for entity in siemplify.target_entities if entity.entity_type == EntityTypes.URL]\n    result_value, output_message = False, ''\n\n    try:\n        manager = PulsediveManager(api_root=api_root, api_key=api_key, verify_ssl=verify_ssl)\n\n        for entity in suitable_entities:\n            siemplify.LOGGER.info(\"Started processing entity: {}\".format(get_entity_original_identifier(entity)))\n            \n            try:\n                identifier = get_entity_original_identifier(entity)\n                is_risky = False\n                url_data = manager.get_indicator_data(indicator=identifier, retrieve_comments=retrieve_comments,\n                                                          comment_limit=max_returned_comments)\n    \n                if int(RISK_SCORE.get(url_data.threshold)) >= int(RISK_SCORE.get(RISK_NAME.get(threshold))):\n                    is_risky = True\n                    entity.is_suspicious = True\n                    global_is_risky = True\n                \n                # Enrich entity\n                enrichment_data = url_data.to_enrichment_data()\n                entity.additional_properties.update(enrichment_data)\n                \n                # Fill json with every entity data\n                json_results[get_entity_original_identifier(entity)] = url_data.to_json(comments=url_data.comments)\n                \n                # Create case wall table for comments\n                if url_data.comments:\n                    comments_table = construct_csv([comment.to_table() for comment in url_data.comments])\n                    siemplify.result.add_data_table(title=\"Comments: {}\".format(get_entity_original_identifier(entity)),\n                                                    data_table=comments_table)\n    \n                if not only_suspicious_insight or (only_suspicious_insight and is_risky):\n                    siemplify.add_entity_insight(entity, url_data.to_insight(threshold),\n                                                 triggered_by=INTEGRATION_NAME)\n    \n                entity.is_enriched = True\n                successful_entities.append(entity)\n                siemplify.LOGGER.info(\"Finished processing entity {0}\".format(get_entity_original_identifier(entity)))\n    \n            except Exception as e:\n                if isinstance(e, ForceRaiseException):\n                    raise\n                failed_entities.append(get_entity_original_identifier(entity))\n                siemplify.LOGGER.error(\"An error occurred on entity {0}\".format(get_entity_original_identifier(entity)))\n                siemplify.LOGGER.exception(e)\n    \n        if successful_entities:\n            output_message += \"Successfully enriched the following URLs using {}: \\n {} \\n\" \\\n                .format(PROVIDER_NAME,\n                        ', '.join([get_entity_original_identifier(entity) for entity in successful_entities]))\n            siemplify.update_entities(successful_entities)\n    \n        if failed_entities:\n            output_message += \"Action wasn’t able to enrich the following URLs using {}: \\n {} \\n\" \\\n                .format(PROVIDER_NAME, ', '.join(failed_entities))\n    \n        if not successful_entities:\n            output_message = \"No URLs were enriched\"\n            result_value = False\n    \n        # Main JSON result\n        if json_results:\n            result = {\n                'results': convert_dict_to_json_result_dict(json_results),\n                'is_risky': global_is_risky\n            }\n            siemplify.result.add_result_json(result)\n                                                                    \n    except Exception as err:\n        output_message = \"Error executing action “Enrich URL”. Reason: {}\".format(err)\n        result_value = False\n        status = EXECUTION_STATE_FAILED\n        siemplify.LOGGER.error(output_message)\n        siemplify.LOGGER.exception(err)\n\n    siemplify.LOGGER.info(\"----------------- Main - Finished -----------------\")\n    siemplify.LOGGER.info(\"Status: {}:\".format(status))\n    siemplify.LOGGER.info(\"Result Value: {}\".format(result_value))\n    siemplify.LOGGER.info(\"Output Message: {}\".format(output_message))\n    siemplify.end(output_message, result_value, status)\n\n\nif __name__ == \"__main__\":\n    main()\n",
  "IntegrationIdentifier": "Pulsedive",
  "ScriptResultName": "is_success",
  "DynamicResultsMetadata": [
    {
      "ResultName": "JsonResult",
      "ResultExample": "{\n  \"results\": [\n    {\n      \"Entity\": \"pulsedive.com\",\n      \"EntityResult\": {\n        \"iid\": 53929,\n        \"type\": \"domain\",\n        \"indicator\": \"pulsedive.com\",\n        \"risk\": \"none\",\n        \"risk_recommended\": \"none\",\n        \"manualrisk\": 0,\n        \"retired\": \"test\",\n        \"stamp_added\": \"2017-10-04 01:20:55\",\n        \"stamp_updated\": \"2021-01-14 07:40:29\",\n        \"stamp_seen\": \"2021-01-14 07:40:29\",\n        \"stamp_probed\": \"2021-01-14 07:40:29\",\n        \"stamp_retired\": null,\n        \"recent\": 0,\n        \"redirects\": {\n          \"to\": [\n            {\n              \"iid\": 642010,\n              \"indicator\": \"https://pulsedive.com/\"\n            }\n          ]\n        },\n        \"riskfactors\": [\n          {\n            \"rfid\": 74,\n            \"description\": \"SPF record present\",\n            \"risk\": \"none\"\n          },\n          {\n            \"rfid\": 44,\n            \"description\": \"registration details hidden\",\n            \"risk\": \"unknown\"\n          }\n        ],\n        \"comments\": [\n          {\n            \"cid\": 125987,\n            \"uid\": 4,\n            \"username\": \"sherd\",\n            \"title\": \"Founder & CEO\",\n            \"comment\": \"Have you seen our Pro tier? \\ud83d\\ude0e\",\n            \"stamp_added\": \"2019-12-18 21:13:46\",\n            \"stamp_updated\": \"2020-11-10 10:03:01\"\n          }\n        ],\n        \"attributes\": {\n          \"port\": [\n            \"443\",\n            \"80\"\n          ],\n          \"protocol\": [\n            \"HTTP\",\n            \"HTTPS\"\n          ],\n          \"technology\": [\n            \"Apache\",\n            \"Font Awesome\",\n            \"Google Analytics\",\n            \"PHP\",\n            \"Stripe\"\n          ]\n        },\n        \"properties\": {\n          \"cookies\": {\n            \"_ga\": \"GA1.2.234824738.1610609947\",\n            \"_gat_gtag_ua_108145347_2\": \"1\",\n            \"_gid\": \"GA1.2.522527771.1610609947\",\n            \"phpsessid\": \"4f67f8dc92c5a9759d02817cefff6524\"\n          },\n          \"dns\": {\n            \"a\": \"45.55.106.210\",\n            \"mname\": \"ns1.digitalocean.com\",\n            \"mx\": [\n              \"alt2.aspmx.l.google.com\",\n              \"alt3.aspmx.l.google.com\",\n              \"alt1.aspmx.l.google.com\",\n              \"alt4.aspmx.l.google.com\",\n              \"aspmx.l.google.com\"\n            ],\n            \"ns\": [\n              \"ns1.digitalocean.com\",\n              \"ns2.digitalocean.com\",\n              \"ns3.digitalocean.com\"\n            ],\n            \"rname\": \"hostmaster@pulsedive.com\",\n            \"soa\": \"ns1.digitalocean.com. hostmaster.pulsedive.com. 1608682181 10800 3600 604800 1800\",\n            \"txt\": [\n              \"v=spf1 a ip4:159.65.224.55 ~all\",\n              \"v=spf1 include:_spf.google.com ~all\"\n            ]\n          },\n          \"dom\": {\n            \"screenshot\": \"\"\n          },\n          \"geo\": {\n            \"address\": \"96 Mowat Ave\",\n            \"city\": \"Toronto\",\n            \"country\": \"Canada\",\n            \"countrycode\": \"CA\",\n            \"org\": \"Contact Privacy Inc. Customer 124912322\",\n            \"region\": \"ON\",\n            \"zip\": \"M4K 3K1\"\n          },\n          \"http\": {\n            \"++code\": \"200\",\n            \"++content-type\": \"text/html\",\n            \"++status\": \"OK\",\n            \"cache-control\": \"no-store, no-cache, must-revalidate\",\n            \"connection\": \"close\",\n            \"content-encoding\": \"gzip\",\n            \"content-type\": \"text/html; charset=utf-8\",\n            \"date\": \"Thu, 14 Jan 2021 07:39:06 GMT\",\n            \"expires\": \"Thu, 19 Nov 1981 08:52:00 GMT\",\n            \"pragma\": \"no-cache\",\n            \"server\": \"Apache\",\n            \"set-cookie\": \"PHPSESSID=4f67f8dc92c5a9759d02817cefff6524; expires=Thu, 21-Jan-2021 07:39:06 GMT; Max-Age=604800; path=/\",\n            \"strict-transport-security\": \"max-age=31536000; includeSubDomains\",\n            \"transfer-encoding\": \"chunked\",\n            \"vary\": \"Accept-Encoding\",\n            \"x-content-type-options\": \"nosniff\",\n            \"x-frame-options\": \"SAMEORIGIN\",\n            \"x-xss-protection\": \"1; mode=block\"\n          },\n          \"meta\": {\n            \"assets\": \"https://pulsedive.com\",\n            \"author\": \"Pulsedive LLC\",\n            \"charset\": \"utf-8\",\n            \"description\": \"Pulsedive is a free threat intelligence platform. Search, scan, and enrich IPs, URLs, domains and other IOCs from OSINT feeds or submit your own.\",\n            \"keywords\": \"threat intelligence,feed,ioc\",\n            \"og:description\": \"Pulsedive is a free threat intelligence platform. Search, scan, and enrich IPs, URLs, domains and other IOCs from OSINT feeds or submit your own.\",\n            \"og:image\": \"https://pulsedive.com/img/opengraph/home.png?v=4.0.90\",\n            \"og:title\": \"Threat Intelligence - Pulsedive\",\n            \"og:url\": \"https://pulsedive.com/\",\n            \"twitter:card\": \"summary_large_image\",\n            \"twitter:creator\": \"@netbroom\",\n            \"twitter:description\": \"Pulsedive is a free threat intelligence platform. Search, scan, and enrich IPs, URLs, domains and other IOCs from OSINT feeds or submit your own.\",\n            \"twitter:image\": \"https://pulsedive.com/img/opengraph/home.png?v=4.0.90\",\n            \"twitter:site\": \"@pulsedive\",\n            \"twitter:title\": \"Threat Intelligence - Pulsedive\",\n            \"version\": \"4.0.90\",\n            \"viewport\": \"width=device-width, initial-scale=1\"\n          },\n          \"ssl\": {\n            \"domain\": [\n              \"www.pulsedive.com\",\n              \"pulsedive.com\"\n            ],\n            \"expires\": \"2021-03-28 18:05:42\",\n            \"issuer\": \"/C=US/O=Let's Encrypt/CN=R3\",\n            \"org\": \"R3\",\n            \"subject\": \"/CN=pulsedive.com\",\n            \"valid\": \"2020-12-28 18:05:42\",\n            \"version\": \"v3\"\n          },\n          \"whois\": {\n            \"++abuse\": \"registrar-abuse@google.com\",\n            \"++email\": \"urb6dpdrhxz4@contactprivacy.email\",\n            \"++expires\": \"2021-11-11 00:00:00\",\n            \"++phone\": \"+1.4165385487\",\n            \"++privacy\": \"1\",\n            \"++registered\": \"2016-11-11 00:00:00\",\n            \"++registrant\": \"Contact Privacy Inc. Customer 124912322\",\n            \"++registrar\": \"Google LLC\",\n            \"++updated\": \"2020-11-12 00:00:00\",\n            \"admin city\": \"Toronto\",\n            \"admin country\": \"CA\",\n            \"admin email\": \"urb6dpdrhxz4@contactprivacy.email\",\n            \"admin name\": \"Contact Privacy Inc. Customer 124912322\",\n            \"admin organization\": \"Contact Privacy Inc. Customer 124912322\",\n            \"admin phone\": \"+1.4165385487\",\n            \"admin postal code\": \"M4K 3K1\",\n            \"admin state/province\": \"ON\",\n            \"admin street\": \"96 Mowat Ave\",\n            \"creation date\": \"2016-11-11T21:18:19Z\",\n            \"dnssec\": \"unsigned\",\n            \"domain name\": \"pulsedive.com\",\n            \"domain status\": \"ok https://www.icann.org/eppRegistry Registrant ID:\",\n            \"name server\": [\n              \"NS1.DIGITALOCEAN.COM\",\n              \"NS2.DIGITALOCEAN.COM\",\n              \"NS3.DIGITALOCEAN.COM\"\n            ],\n            \"please register your domains at\": \"https://domains.google.com/\",\n            \"registrant city\": \"Toronto\",\n            \"registrant country\": \"CA\",\n            \"registrant email\": \"urb6dpdrhxz4@contactprivacy.email\",\n            \"registrant name\": \"Contact Privacy Inc. Customer 124912322\",\n            \"registrant organization\": \"Contact Privacy Inc. Customer 124912322\",\n            \"registrant phone\": \"+1.4165385487\",\n            \"registrant postal code\": \"M4K 3K1\",\n            \"registrant state/province\": \"ON\",\n            \"registrant street\": \"96 Mowat Ave\",\n            \"registrar\": \"Google LLC\",\n            \"registrar abuse contact email\": \"registrar-abuse@google.com\",\n            \"registrar abuse contact phone\": \"+1.8772376466\",\n            \"registrar iana id\": \"895\",\n            \"registrar registration expiration date\": \"2021-11-11T21:18:19Z\",\n            \"registrar url\": \"https://domains.google.com\",\n            \"registrar whois server\": \"whois.google.com\",\n            \"registry domain id\": \"2073459391_DOMAIN_COM-VRSN\",\n            \"tech city\": \"Toronto\",\n            \"tech country\": \"CA\",\n            \"tech email\": \"urb6dpdrhxz4@contactprivacy.email\",\n            \"tech name\": \"Contact Privacy Inc. Customer 124912322\",\n            \"tech organization\": \"Contact Privacy Inc. Customer 124912322\",\n            \"tech phone\": \"+1.4165385487\",\n            \"tech postal code\": \"M4K 3K1\",\n            \"tech state/province\": \"ON\",\n            \"tech street\": \"96 Mowat Ave\",\n            \"updated date\": \"2020-11-12T03:14:58Z\",\n            \"url of the icann whois data problem reporting system\": \"http://wdprs.internic.net/\"\n          }\n        }\n      }\n    }\n  ],\n  \"is_risky\": true\n}",
      "ShowResult": true
    }
  ],
  "Creator": "Admin",
  "IsEnabled": true,
  "IsCustom": false,
  "IsSystem": false,
  "Version": 86.0,
  "TimeoutSeconds": 300,
  "Parameters": [
    {
      "CustomActionId": 0,
      "IsMandatory": false,
      "DefaultValue": "50",
      "Description": "Specify how many comments to return.",
      "Name": "Max Comments To Return",
      "Value": "50",
      "Type": 0,
      "OptionalValues": null,
      "OptionalValuesJson": null,
      "Id": 0,
      "CreationTimeUnixTimeInMs": 1614032395391,
      "ModificationTimeUnixTimeInMs": 1614032395391
    },
    {
      "CustomActionId": 0,
      "IsMandatory": true,
      "DefaultValue": "medium",
      "Description": "Specify the threshold where the entity should be marked as malicious or suspicious, for Siemplify to label it as suspicious. ",
      "Name": "Threshold",
      "Value": "medium",
      "Type": 15,
      "OptionalValues": [
        "verylow",
        "low",
        "medium",
        "high",
        "critical"
      ],
      "OptionalValuesJson": "[\"verylow\",\"low\",\"medium\",\"high\",\"critical\"]",
      "Id": 0,
      "CreationTimeUnixTimeInMs": 1614032395391,
      "ModificationTimeUnixTimeInMs": 1614032395391
    },
    {
      "CustomActionId": 0,
      "IsMandatory": false,
      "DefaultValue": "true",
      "Description": "If enabled, action will retrieve comments about the entity.",
      "Name": "Retrieve Comments",
      "Value": "true",
      "Type": 1,
      "OptionalValues": null,
      "OptionalValuesJson": null,
      "Id": 0,
      "CreationTimeUnixTimeInMs": 1614032395391,
      "ModificationTimeUnixTimeInMs": 1614032395391
    },
    {
      "CustomActionId": 0,
      "IsMandatory": false,
      "DefaultValue": "false",
      "Description": "If enabled, action will only create an insight for suspicious entities.",
      "Name": "Only Suspicious Entity Insight",
      "Value": "false",
      "Type": 1,
      "OptionalValues": null,
      "OptionalValuesJson": null,
      "Id": 0,
      "CreationTimeUnixTimeInMs": 1614032395391,
      "ModificationTimeUnixTimeInMs": 1614032395391
    }
  ],
  "DefaultResultValue": null,
  "PythonVersion": "None",
  "SimulationData": {
    "Entities": null
  },
  "SimulationDataJson": null,
  "Id": 0,
  "IsAsync": true,
  "CreationTimeUnixTimeInMs": 1612476395892,
  "ModificationTimeUnixTimeInMs": 1614032395385
}